<!--HTML-->

<html>
    <image src='oxweb-logo.gif'></image>
  <!--CSS-->
  <link rel="stylesheet" href="Styles.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
 
  <div id='Intro'>
  <head>
 <h1>
  Machine Learning in Prognostic Prediction Decision-Support Systems Study
 </h1>
</head>
  <h3>Details</h3>
  <p>
    Thank you for your interest in our study.</br>
    The purpose of the study is to investigate the potential value of Machine Learning models in generating prognostic predictions as part of decision-support systems designed to augment and complement the work of medical professionals and diagnosticians.<br/>
    The study proceeds by presenting 3 patient scenarios, focusing on patients who have experienced heart failure. Each scenario is followed by a predicted risk score generated from one of three models:
    <ul>
        <li>Linear Regression</li>
        <li>Random Forest</li>
        <li>Neural Network</li>
    </ul> 
    
    The study presents various forms of evidence, interpretations, and representations of these models to learn how best to increase medical experts' confidence in Machine Learning models.<br/><br/>
    Please click below for full details before you start the survey.</p>
    <button class = 'showStudyInfo'>Full Study Info</button>
  <div class='studyInfo' style='font-size:75%;'>
    <h5>General Information</h5>
        <p>Machine Learning and Artificial Intelligence models are gaining enthusiasm for their ability to produce highly accurate predictive and analytical insights. However, as many such models, including neural networks, are <i>black-boxes</i>, many fields of practice are reluctant to utilize these models without an ability to interpret their results or understand a model made its prediction.</p>
        <p>The aim of this study is to explore this phenomenon and understand what type of model evidence and interpretability modules will increase comprehension and the comfort levels for users of different machine learning predictive models.</p>
        <p>We appreciate your interest in participating in this online survey. You have been invited to participate as a student in a STEM discipline. Please read through these terms before beginning the survey. You will participate by ticking the <i>Start</i> box below. You may ask any questions before taking part by contacting the researcher (details below).</p>
        <p>We, the University of Oxford, are investigating Machine Learning model interpretability. You will be presented with limited information on a machine learning model, followed by further evidence regrading the model. You will then be asked to rate your confidence level with utilizing the model for predictive purposes.</p>
        <p>The full survey should take about 10-15 minutes. No background knowledge is required. Your results will be utilized to determine the best interpretability modules and types of evidence to present to potential users of different machine learning models, and will be collected and utilized by the Computer Science and Engineering Departments at Oxford. <b>No personally identifiable information will be collected or shared</b>.</p>
    <h5>Do I have to take part?</h5>
        <p>Please note that your participation is voluntary. You may withdraw at any point during the questionnaire for any reason, before submitting your answers, by closing the browser. None of your answers will then be collected.</p>
    <h5>How will your data be used?</h5>
        <p>Your answers will be completely anonymous, and we will use all reasonable endeavours to keep them confidential. No personally identifiable, including but not limited to IP address, email address, or name, will be requested or collected.</p>
        <p>Your answers will be stored in a password-protected file and may be used in academic publications. Your IP address will not be stored. Research data will be stored for a minimum of three years after publication or public release.</p>
    <h5>Who will have access to your data?</h5>
        <p>The University of Oxford is the data controller for the purposes of the Data Protection Act 1998.</p>
        <p>We would like your permission to use your unidentifiable data in future studies, and to share data with other researchers (e.g. in online databases).</p>
        <p>Any personal information that could identify you will not be collected or be removed before files are shared with other researchers or results are made public.</p>
        <p>This questionnaire is for an MSc project. The principal researcher is Owen Lahav, who is attached to the Department of Computer Science at the University of Oxford. This project is being completed under the supervision of Mihaela van der Schaar and Edith Elkind. This project has been reviewed by the University of Oxford’s Department of Computer Science’s Research Ethics Committee.</p>
    <h5>What if there is a problem?</h5>
        <p>If you have a concern about any aspect of this project, please speak to the researcher at oren.lahav@gtc.ox.ac.uk who will do his best to answer your query. The researcher should acknowledge your concern within 10 working days and give you an indication of how they intend to deal with it.</p>
        <p>If you are over 18 and have read the information above and agree to participate with the understanding that the data (including any personal data) you submit will be processed accordingly, please click the ‘Start’ box below to get started. By doing so you will be providing your consent to participate.</p>
  </div>
    <h3>Instructions:</h3>
  <p>
    Please carefully review the patient scenario and evidence presented, and answer the subsequent questions indicating your expectations on medical experts' confidence in the models and their predicted outputs.
    <b>Please do not use the back/forward or refresh buttons once you have started the survey.</b>
  </p>
 </div>

 <div class = 'startQuiz'>
     <h3>Start</h3>
     <p>If you are ready to begin, please indicate your background of expertise:</p>
     <form class='contextForm'>
            <input type='radio' class='contextQ' name='contextQ' value=0> Medicine<br>
            <input type='radio' class='contextQ' name='contextQ' value=1> Computer Science<br>
            <input type='radio' class='contextQ' name='contextQ' value=2> Other<br><br> 
            <input type='submit' value='Start'>    
     </form>
  </div>

 <div id = 'Rest'></div>

 <div class = 'commentSection'>
    <h3>Comments</h3>
    <p>Please leave any feedback, comments, or concerns about the survey you have just completed.</p>
    <p>In particular, you may address the following:
        <ul>
            <li>What are your general thoughts about Machine Learning in decision-support systems for prognostic predictive purposes?</li>
            <li>In your opinion, would any of the model evidence and other information shown be particularly effective or ineffective at increasing medical experts' confidence in ML models? Why?</li>
            <li>Is there anything else pertaining to the models and patient scenarios you would have liked to see?</li>
            <li>Were there any areas of the survey you felt were confusing or potentially misleading?</li>
            <li><b>Do you feel that the models presented might augment medical experts' judgement and constitute a valuable contribution to future decision-support systems?</b> Why, or why not?</li>
        </ul>
    </p>
    <p><b>Important:</b> Do <b>not</b> include any personally identifiable information, such as name or email address, in your answer below.</p>
    <p>You may also email the primary researcher at oren.lahav@gtc.ox.ac.uk.</p>
    <form class = 'commentForm' id = 'Feedback'>
        <textarea comments cols=120 rows=5 placeholder='Feedback:' form = 'Feedback'></textarea>
        <br />
        <button class = 'FeedbackButton'>Submit</button>
    </form>
 </div>

 <div class = 'finished'>
     <h3>Finished!!!</h3>
    <p>
        Thank you very much for taking our survey. Your anonymous results will be used in a model that shall determine the best evidence to present to potential users of ML models.
    </p>
</div>
 
<!--CODE-->

<!--Setup Firebase-->
<script src="https://www.gstatic.com/firebasejs/5.1.0/firebase.js"></script>
<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyCGsk1r6jbIo3MDFMDquKqG3rb7ksK5wuY",
    authDomain: "interpretabilityfinal.firebaseapp.com",
    databaseURL: "https://interpretabilityfinal.firebaseio.com",
    projectId: "interpretabilityfinal",
    storageBucket: "interpretabilityfinal.appspot.com",
    messagingSenderId: "686046306112"
  };
  firebase.initializeApp(config);
</script>

<!--Download jQuery-->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>

<!--Actual code-->
  <script>
    //Setup variables:

    
    var part1 = {
        header : '<b>Part 2:</b> Logistic Regression Model',
        description : '<p>The following questions pertain to a <b>logistic regression</b> model, which is similar to linear regression but outputs classification probabilities. The model was trained on a Heart Failure dataset with over 30,000 patients, and utilizes several features to predict the event that a patient suffering heart failure will die within one year.</p><p>Please examine the following scenario and relevant evidence in order and assess your level of confidence in the model after each step.</p>',
        questions : [
            {
                questionText : '<image src="S0Q0O0.png" style="width:700px;"></image><p>Given the above only, how confident would you expect an average medical expert to feel about using the results of the model and the predicted risk score of 27.6% to inform medical actions?</p>',
                answers: ['Not at all confident, would not even consider model and prediction when considering further action',
                            'Not very confident, unlikely to consider model',
                            'Somewhat confident, may consult model but unlikely to rely on it in any way',
                            'Fairly confident, likely to consult model and consider its predicted score',
                            'Very confident, almost certain to consult model together with other tools when considering further actions'
                ]
            },
            {
                questionText : '<image src="S0Q1O0.png" style="width:1000px;"></image><p>Given the above and previous information, how confident would you expect an average medical expert to feel about using the results of the model and the predicted risk score of 27.6% to inform medical actions?</p>',
                answers: ['Not at all confident, would not even consider model and prediction when considering further action',
                            'Not very confident, unlikely to consider model',
                            'Somewhat confident, may consult model but unlikely to rely on it in any way',
                            'Fairly confident, likely to consult model and consider its predicted score',
                            'Very confident, almost certain to consult model together with other tools when considering further actions'
                ]
            },
            {
                questionText : '<image src="S0Q1O1.png" style="width:1000px;"></image><p>Given the above and previous information, how confident would you expect an average medical expert to feel about using the results of the model and the predicted risk score of 27.6% to inform medical actions?</p>',
                answers: ['Not at all confident, would not even consider model and prediction when considering further action',
                            'Not very confident, unlikely to consider model',
                            'Somewhat confident, may consult model but unlikely to rely on it in any way',
                            'Fairly confident, likely to consult model and consider its predicted score',
                            'Very confident, almost certain to consult model together with other tools when considering further actions'
                ]
            },
            {
                questionText : '<image src="S0Q2O0.png" style="width:1000px;"></image><p>Given the above and previous information, how confident would you expect an average medical expert to feel about using the results of the model and the predicted risk score of 27.6% to inform medical actions?</p>',
                answers: ['Not at all confident, would not even consider model and prediction when considering further action',
                            'Not very confident, unlikely to consider model',
                            'Somewhat confident, may consult model but unlikely to rely on it in any way',
                            'Fairly confident, likely to consult model and consider its predicted score',
                            'Very confident, almost certain to consult model together with other tools when considering further actions'
                ]
            },
            {
                questionText : '<image src="S0Q2O1.png" style="width:1000px;"></image><p>Given the above and previous information, how confident would you expect an average medical expert to feel about using the results of the model and the predicted risk score of 27.6% to inform medical actions?</p>',
                answers: ['Not at all confident, would not even consider model and prediction when considering further action',
                            'Not very confident, unlikely to consider model',
                            'Somewhat confident, may consult model but unlikely to rely on it in any way',
                            'Fairly confident, likely to consult model and consider its predicted score',
                            'Very confident, almost certain to consult model together with other tools when considering further actions'
                ]
            },
            {
                questionText : '<image src="S0Q3O0.png" style="width:1000px;"></image><p>Given the above and previous information, how confident would you expect an average medical expert to feel about using the results of the model and the predicted risk score of 27.6% to inform medical actions?</p>',
                answers: ['Not at all confident, would not even consider model and prediction when considering further action',
                            'Not very confident, unlikely to consider model',
                            'Somewhat confident, may consult model but unlikely to rely on it in any way',
                            'Fairly confident, likely to consult model and consider its predicted score',
                            'Very confident, almost certain to consult model together with other tools when considering further actions'
                ]
            }
        ]
    };

    var part2 = {
        header : '<b>Part 3:</b> Neural Network',
        description : '<p>The following questions pertain to a <b>neural network</b>, a sophisticated black-box machine learning model. The model was trained on the same Heart Failure dataset and utilizes several features to predict the event that a patient suffering heart failure will die within one year.</p><p>Please examine the following scenario and relevant evidence in order and assess your level of confidence in the model after each step.</p>',
        questions : [
            {
                questionText : '<image src="S1Q0O0.png" style="width:700px;"></image><p>Given the above only, how confident would you expect an average medical expert to feel about using the results of the model and the predicted risk scores to inform medical actions?</p>',
                answers: ['Not at all confident, would not even consider model and prediction when considering further action',
                            'Not very confident, unlikely to consider model',
                            'Somewhat confident, may consult model but unlikely to rely on it in any way',
                            'Fairly confident, likely to consult model and consider its predicted score',
                            'Very confident, almost certain to consult model together with other tools when considering further actions'
                ]
            },
            {
                questionText : '<image src="S1Q1O0.png" style="width:1000px;"></image><p>Given the above and previous information, how confident would you expect an average medical expert to feel about using the results of the model and the predicted risk scores to inform medical actions?</p>',
                answers: ['Not at all confident, would not even consider model and prediction when considering further action',
                            'Not very confident, unlikely to consider model',
                            'Somewhat confident, may consult model but unlikely to rely on it in any way',
                            'Fairly confident, likely to consult model and consider its predicted score',
                            'Very confident, almost certain to consult model together with other tools when considering further actions'
                ]
            },
            {
                questionText : '<image src="S1Q2O0.png" style="width:1000px;"></image><p>Given the above and previous information, how confident would you expect an average medical expert to feel about using the results of the model and the predicted risk scores to inform medical actions?</p>',
                answers: ['Not at all confident, would not even consider model and prediction when considering further action',
                            'Not very confident, unlikely to consider model',
                            'Somewhat confident, may consult model but unlikely to rely on it in any way',
                            'Fairly confident, likely to consult model and consider its predicted score',
                            'Very confident, almost certain to consult model together with other tools when considering further actions'
                ]
            },
            {
                questionText : '<image src="S1Q2O1.png" style="width:1000px;"></image><p>Given the above and previous information, how confident would you expect an average medical expert to feel about using the results of the model and the predicted risk scores to inform medical actions?</p>',
                answers: ['Not at all confident, would not even consider model and prediction when considering further action',
                            'Not very confident, unlikely to consider model',
                            'Somewhat confident, may consult model but unlikely to rely on it in any way',
                            'Fairly confident, likely to consult model and consider its predicted score',
                            'Very confident, almost certain to consult model together with other tools when considering further actions'
                ]
            },
            {
                questionText : '<image src="S1Q3O0.png" style="width:1000px;"></image><p>Given the above and previous information, how confident would you expect an average medical expert to feel about using the results of the model and the predicted risk scores to inform medical actions?</p>',
                answers: ['Not at all confident, would not even consider model and prediction when considering further action',
                            'Not very confident, unlikely to consider model',
                            'Somewhat confident, may consult model but unlikely to rely on it in any way',
                            'Fairly confident, likely to consult model and consider its predicted score',
                            'Very confident, almost certain to consult model together with other tools when considering further actions'
                ]
            },
            {
                questionText : '<image src="S1Q3O1.png" style="width:1000px;"></image><p>Given the above and previous information, how confident would you expect an average medical expert to feel about using the results of the model and the predicted risk scores to inform medical actions?</p>',
                answers: ['Not at all confident, would not even consider model and prediction when considering further action',
                            'Not very confident, unlikely to consider model',
                            'Somewhat confident, may consult model but unlikely to rely on it in any way',
                            'Fairly confident, likely to consult model and consider its predicted score',
                            'Very confident, almost certain to consult model together with other tools when considering further actions'
                ]
            },
            {
                questionText : '<image src="S1Q4O0.png" style="width:1000px;"></image><p>Given the above and previous information, how confident would you expect an average medical expert to feel about using the results of the model and the predicted risk scores to inform medical actions?</p>',
                answers: ['Not at all confident, would not even consider model and prediction when considering further action',
                            'Not very confident, unlikely to consider model',
                            'Somewhat confident, may consult model but unlikely to rely on it in any way',
                            'Fairly confident, likely to consult model and consider its predicted score',
                            'Very confident, almost certain to consult model together with other tools when considering further actions'
                ]
            }
        ]
    };

    var part3 = {
        header : '<b>Part 4:</b> Random Forest',
        description : '<p>The following questions pertain to a <b>random forest</b>, a black-box machine learning algorithm that utilizes multiple decision trees. The model was trained on the same Heart Failure dataset and utilizes several features to predict the event that a patient suffering heart failure will die within one year.</p><p>Please examine the following scenario and relevant evidence in order and assess your level of confidence in the model after each step.</p>',
        questions : [
            {
                questionText : '<image src="S2Q0O0.png" style="width:700px;"></image><p>Given the above only, how confident would you expect an average medical expert to feel about using the results of the model and the predicted risk score of 63.8% to inform medical actions?</p>',
                answers: ['Not at all confident, would not even consider model and prediction when considering further action',
                            'Not very confident, unlikely to consider model',
                            'Somewhat confident, may consult model but unlikely to rely on it in any way',
                            'Fairly confident, likely to consult model and consider its predicted score',
                            'Very confident, almost certain to consult model together with other tools when considering further actions'
                ]
            },
            {
                questionText : '<image src="S2Q1O0.png" style="width:1000px;"></image><p>Given the above and previous information, how confident would you expect an average medical expert to feel about using the results of the model and the predicted risk score of 63.8% to inform medical actions?</p>',
                answers: ['Not at all confident, would not even consider model and prediction when considering further action',
                            'Not very confident, unlikely to consider model',
                            'Somewhat confident, may consult model but unlikely to rely on it in any way',
                            'Fairly confident, likely to consult model and consider its predicted score',
                            'Very confident, almost certain to consult model together with other tools when considering further actions'
                ]
            },
            {
                questionText : '<image src="S2Q2O0.png" style="width:1000px;"></image><p>Given the above and previous information, how confident would you expect an average medical expert to feel about using the results of the model and the predicted risk score of 63.8% to inform medical actions?</p>',
                answers: ['Not at all confident, would not even consider model and prediction when considering further action',
                            'Not very confident, unlikely to consider model',
                            'Somewhat confident, may consult model but unlikely to rely on it in any way',
                            'Fairly confident, likely to consult model and consider its predicted score',
                            'Very confident, almost certain to consult model together with other tools when considering further actions'
                ]
            },
            {
                questionText : '<image src="S2Q3O0.png" style="width:1000px;"></image><p>Given the above and previous information, how confident would you expect an average medical expert to feel about using the results of the model and the predicted risk score of 63.8% to inform medical actions?</p>',
                answers: ['Not at all confident, would not even consider model and prediction when considering further action',
                            'Not very confident, unlikely to consider model',
                            'Somewhat confident, may consult model but unlikely to rely on it in any way',
                            'Fairly confident, likely to consult model and consider its predicted score',
                            'Very confident, almost certain to consult model together with other tools when considering further actions'
                ]
            },
            {
                questionText : '<image src="S2Q4O0.png" style="width:1000px;"></image><p>Given the above and previous information, how confident would you expect an average medical expert to feel about using the results of the model and the predicted risk score of 63.8% to inform medical actions?</p>',
                answers: ['Not at all confident, would not even consider model and prediction when considering further action',
                            'Not very confident, unlikely to consider model',
                            'Somewhat confident, may consult model but unlikely to rely on it in any way',
                            'Fairly confident, likely to consult model and consider its predicted score',
                            'Very confident, almost certain to consult model together with other tools when considering further actions'
                ]
            },
            {
                questionText : '<image src="S2Q4O1.png" style="width:1000px;"></image><p>Given the above and previous information, how confident would you expect an average medical expert to feel about using the results of the model and the predicted risk score of 63.8% to inform medical actions?</p>',
                answers: ['Not at all confident, would not even consider model and prediction when considering further action',
                            'Not very confident, unlikely to consider model',
                            'Somewhat confident, may consult model but unlikely to rely on it in any way',
                            'Fairly confident, likely to consult model and consider its predicted score',
                            'Very confident, almost certain to consult model together with other tools when considering further actions'
                ]
            },
            {
                questionText : '<image src="S2Q5O0.png" style="width:1000px;"></image><p>Given the above and previous information, how confident would you expect an average medical expert to feel about using the results of the model and the predicted risk score of 63.8% to inform medical actions?</p>',
                answers: ['Not at all confident, would not even consider model and prediction when considering further action',
                            'Not very confident, unlikely to consider model',
                            'Somewhat confident, may consult model but unlikely to rely on it in any way',
                            'Fairly confident, likely to consult model and consider its predicted score',
                            'Very confident, almost certain to consult model together with other tools when considering further actions'
                ]
            }
        ]
    };

    var parts = [part1, part2, part3];

    //var answerKey = [0,2];

    var sequenceData = [
        {
            context : 0,
            contextCounter : 0,
            contextData : 
            [
                {
                    section: 1, possibleSequences:[
                        {seqCode:'S0U0', seq: [1,1,0,1,0,0], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S0U1', seq: [1,1,0,1,0,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S0U2', seq: [1,0,1,1,0,0], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S0U3', seq: [1,0,1,1,0,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S0U4', seq: [1,1,0,0,1,0], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S0U5', seq: [1,1,0,0,1,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S0U6', seq: [1,0,1,0,1,0], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S0U7', seq: [1,0,1,0,1,1], numTries: 0, currentMean : 2, currentUCB : 10}
                    ]
                },
                {
                    section: 2, possibleSequences:[
                        {seqCode:'S1U0', seq: [1,1,1,0,0,0,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S1U1', seq: [1,1,0,1,0,0,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S1U2', seq: [1,1,0,0,1,0,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S1U3', seq: [1,1,0,0,0,1,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S1U4', seq: [1,1,1,0,1,0,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S1U5', seq: [1,1,0,1,1,0,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S1U6', seq: [1,1,1,0,0,1,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S1U7', seq: [1,1,0,1,0,1,1], numTries: 0, currentMean : 2, currentUCB : 10}
                    ]
                },
                {
                    section: 3, possibleSequences:[
                        {seqCode:'S2U0', seq: [1,1,1,0,0,0,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S2U1', seq: [1,1,1,1,0,0,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S2U2', seq: [1,1,1,0,1,0,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S2U3', seq: [1,1,1,0,0,1,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S2U4', seq: [1,1,0,1,0,0,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S2U5', seq: [1,1,0,0,1,0,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S2U6', seq: [1,1,0,0,0,1,1], numTries: 0, currentMean : 2, currentUCB : 10}
                    ]
                }
            ]
        },
        {
            context : 1,
            contextCounter : 0,
            contextData : 
            [
            {
                    section: 1, possibleSequences:[
                        {seqCode:'S0U0', seq: [1,1,0,1,0,0], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S0U1', seq: [1,1,0,1,0,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S0U2', seq: [1,0,1,1,0,0], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S0U3', seq: [1,0,1,1,0,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S0U4', seq: [1,1,0,0,1,0], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S0U5', seq: [1,1,0,0,1,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S0U6', seq: [1,0,1,0,1,0], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S0U7', seq: [1,0,1,0,1,1], numTries: 0, currentMean : 2, currentUCB : 10}
                    ]
                },
                {
                    section: 2, possibleSequences:[
                        {seqCode:'S1U0', seq: [1,1,1,0,0,0,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S1U1', seq: [1,1,0,1,0,0,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S1U2', seq: [1,1,0,0,1,0,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S1U3', seq: [1,1,0,0,0,1,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S1U4', seq: [1,1,1,0,1,0,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S1U5', seq: [1,1,0,1,1,0,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S1U6', seq: [1,1,1,0,0,1,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S1U7', seq: [1,1,0,1,0,1,1], numTries: 0, currentMean : 2, currentUCB : 10}
                    ]
                },
                {
                    section: 3, possibleSequences:[
                        {seqCode:'S2U0', seq: [1,1,1,0,0,0,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S2U1', seq: [1,1,1,1,0,0,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S2U2', seq: [1,1,1,0,1,0,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S2U3', seq: [1,1,1,0,0,1,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S2U4', seq: [1,1,0,1,0,0,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S2U5', seq: [1,1,0,0,1,0,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S2U6', seq: [1,1,0,0,0,1,1], numTries: 0, currentMean : 2, currentUCB : 10}
                    ]
                }
            ]
        },
        {
            context : 2,
            contextCounter : 0,
            contextData : 
            [
            {
                    section: 1, possibleSequences:[
                        {seqCode:'S0U0', seq: [1,1,0,1,0,0], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S0U1', seq: [1,1,0,1,0,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S0U2', seq: [1,0,1,1,0,0], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S0U3', seq: [1,0,1,1,0,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S0U4', seq: [1,1,0,0,1,0], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S0U5', seq: [1,1,0,0,1,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S0U6', seq: [1,0,1,0,1,0], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S0U7', seq: [1,0,1,0,1,1], numTries: 0, currentMean : 2, currentUCB : 10}
                    ]
                },
                {
                    section: 2, possibleSequences:[
                        {seqCode:'S1U0', seq: [1,1,1,0,0,0,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S1U1', seq: [1,1,0,1,0,0,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S1U2', seq: [1,1,0,0,1,0,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S1U3', seq: [1,1,0,0,0,1,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S1U4', seq: [1,1,1,0,1,0,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S1U5', seq: [1,1,0,1,1,0,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S1U6', seq: [1,1,1,0,0,1,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S1U7', seq: [1,1,0,1,0,1,1], numTries: 0, currentMean : 2, currentUCB : 10}
                    ]
                },
                {
                    section: 3, possibleSequences:[
                        {seqCode:'S2U0', seq: [1,1,1,0,0,0,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S2U1', seq: [1,1,1,1,0,0,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S2U2', seq: [1,1,1,0,1,0,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S2U3', seq: [1,1,1,0,0,1,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S2U4', seq: [1,1,0,1,0,0,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S2U5', seq: [1,1,0,0,1,0,1], numTries: 0, currentMean : 2, currentUCB : 10},
                        {seqCode:'S2U6', seq: [1,1,0,0,0,1,1], numTries: 0, currentMean : 2, currentUCB : 10}
                    ]
                }
            ]
        }
    ];


    var questionCounter = 0;
    var sectionCounter = 0;
    var numContexts = 0;

    //Create function to display a question:
    function displayQuestion(qNum, q)
    {
        var output = [];
        var answersList = [];

        //Setup answers one by one
        for(ans in q.answers)
        {
            ansNum = parseInt(ans) + 1;

            answersList.push(
                '<label class="question question'+qNum+'">'
					+ '<input type="radio" name="question'+qNum+'" class="question'+qNum+'" value="'+ans+'">'
					+ (ansNum) + ': '
					+ q.answers[ans]
				+ '</label><br />'
			    );
		}

        //Push question text and answers
        output.push(
			'<div class="question question'+qNum+'">' + q.questionText + '<br />'
			+ '<div class="answers">' + answersList.join('') + '<br /></div>'
            + '<div value="'+qNum+'" class="button question question'+qNum+'"><button>Next</button></div></div>'
		);
        //console.log(output)

        //Add output to current HTML
        return output;
    }

    function displaySection(sectionNum,section)
    {
        output = [];
        questionList = [];

        //Display ALL questions (we'll hide them later)
        for(var q=0; q<section.questions.length; q++)
        {
           questionList.push(displayQuestion(questionCounter,section.questions[q]));
           questionCounter++;
        }
        
        //Add question list to output and return
        output.push(
            '<div class="section section'+sectionNum+'"><h3>' 
            + section.header 
            +'</h3><p>'
            + section.description
            + '</p>'
            + '<div class="questions">' + questionList.join('') + '</div></div>'
        );

        return output;
    }

    function displayAll(sectionList)
    {
        output = ''
        for(var s = 0; s<sectionList.length;s++)
        {
            output = output+displaySection(sectionCounter,sectionList[s]);
            sectionCounter++;
        }
        return output
    }

    var dbAccesses = 1;
    var dbSeqData;


    //Function to choose, based on UCB, which sequence to show
    function chooseSequence()
    {
        seqToRun = [];
        runSummary = [];

        //First things first - get latest prob from DB
        var dbRefProbs = firebase.database().ref('Probs');


        //Code to reset probs when we're testing something new - comment out

        //returnData = 
        //            {
        //                name:'X',
        //                data:sequenceData,
        //                accessCount:0
        //            };
        //            console.log(returnData);
        //
        //            //Log the updates
        //            dbRefProbs.set(returnData); 

        dbRefProbs.once('value', (response) => {
            
                dbData = response.val().data;
                dbAccesses = response.val().accessCount;
                console.log(dbData);
                console.log('Accesses: '+dbAccesses);

                //For! Each context:

                for (var ctxt = 0; ctxt < dbData.length; ctxt++)
                {
                    contextSeqData = dbData[ctxt].contextData;
                    //console.log('Context Data:')
                    //console.log(contextSeqData)

                    contextSeqToRun = [];
                    contextRunSummary = [];

                    //For! Each section:
                    for (var sect = 0; sect < contextSeqData.length; sect++)
                    {
                        //console.log('Section?');
                        //console.log(sect);
                        //console.log(contextSeqData[sect].possibleSequences);

                        topSeq = [];
                        topCode = '';
                        UCBTrack = 0;

                        possSeqs = contextSeqData[sect].possibleSequences;
                    
                        //Cycle through sequences
                        for (var pSeq = 0; pSeq < possSeqs.length; pSeq++)
                        {
                            //If UCB is higher than the previous one, set this sequence to be chosen
                            if (possSeqs[pSeq].currentUCB >= UCBTrack)
                            {
                                topCode = possSeqs[pSeq].seqCode;
                                topSeq = possSeqs[pSeq].seq;
                                UCBTrack = possSeqs[pSeq].currentUCB;
                            }
                        }

                        contextSeqToRun = contextSeqToRun.concat(topSeq);
                        contextRunSummary.push({
                            sectionNo: contextSeqData[sect].section,
                            seqCode : topCode,
                            seqDesc : topSeq
                        });

                    }



                    seqToRun.push(contextSeqToRun);
                    runSummary.push({contextNo: ctxt, seqData: contextRunSummary});


                }

                console.log('This trial we shall run:')
                console.log(seqToRun);
                console.log(runSummary);
        });
    }


    //Function to update UCB once survey is done

    function updateUBC(resultList, initialSeqData, runSummary, numAccess)
    {
        console.log('UBC Update Step initiate!');
        console.log(initialSeqData);

        //Update total number of accesses
        upAccesses = numAccess + 1;
        upSeqData = [];
        upContextCount = 0;

        for (var ctxt = 0; ctxt < initialSeqData.length; ctxt++)
        {
            currentData = initialSeqData[ctxt];

            if (ctxt != userContext)
            {
                upSeqData.push(currentData);
            }

            else
            {
                console.log('hit context '+ctxt)
                //Set up the updated sequence data vector to return.
                //Section0, the context question, always remains the same:
                qSoFar = 0;

                upContextCount = currentData.contextCounter + 1;
                currentData = currentData.contextData;
                contextUpSeqData = [];

                //For every section
                for(var a = 0; a < currentData.length; a++)
                {
                    sectData = currentData[a];
                    //console.log('sectData');
                    //console.log(sectData);

                    //Find the final confidence score in the model (that's our reward):
                    qSoFar = qSoFar + sectData.possibleSequences[0].seq.length
                    confScore = resultList[qSoFar-1];
                    wloop = qSoFar - 2;
                    while(confScore == -1 && qSoFar >= 0)
                    {
                        confScore = resultList[wloop];
                        wloop = wloop - 1;
                    }

                    //console.log('score?');
                    //console.log(confScore);

                    ranCode = runSummary[userContext].seqData[a].seqCode;
                    //console.log(ranCode);

                    upPossSeq = [];

                    //For each possible sequence:
                    for (var b = 0; b < sectData.possibleSequences.length; b++)
                    {
                        curSeq = sectData.possibleSequences[b];

                        //If we're at the sequence we ran, we must update many things:
                        if (curSeq.seqCode == ranCode)
                        {
                            upTries = curSeq.numTries + 1;
                            upMean = ((curSeq.currentMean*curSeq.numTries) + parseInt(confScore))/upTries;
                            upUCB = upMean + Math.min(Math.sqrt(2*(Math.log(upAccesses)/Math.log(upTries))),10);

                            //Check for NaN:
                            if (isNaN(upUCB) || upTries<=1) {upUCB=10;}
                        }
                        else
                        {
                            upTries = curSeq.numTries;
                            upMean = curSeq.currentMean;
                            upUCB = upMean + Math.min(Math.sqrt(2*(Math.log(upAccesses)/Math.log(upTries))),10);

                            //Check for NaN:
                            if (isNaN(upUCB) || upTries<=1) {upUCB=10;}
                        }

                        upSeq = {
                            seqCode : curSeq.seqCode,
                            seq : curSeq.seq,
                            numTries : upTries,
                            currentMean : upMean,
                            currentUCB : upUCB
                        };

                        //console.log('upSeq');
                        //console.log(upSeq);

                        upPossSeq.push(upSeq);
                    }

                    upSect = {section:a, possibleSequences:upPossSeq};
                    contextUpSeqData.push(upSect);
                    //console.log('upSect')
                    //console.log(upSect)
                    //console.log(contextUpSeqData)
                }

                upSeqData.push({context: ctxt, contextCounter : upContextCount, contextData: contextUpSeqData});                

            }

            
        }
        console.log('Updated UCB Values: ')
        console.log(upSeqData);
        return upSeqData;
    }

    //Variables to store data:
    userContext = 0;
    dataReturn = [];
    whys = [];
    var initialSeqData;

    //Set code to run once page is loaded
    $(document).ready(function() {

        //Prepare things to display:
        var pageStuff = document.getElementById('Rest');
        pageContent = displayAll(parts);
        pageStuff.innerHTML = pageStuff.innerHTML + pageContent;

        console.log(pageStuff.innerHTML);

        //Figure out the sequence
        chooseSequence();

        //All the action starts here!

        //Hide all questions and sections:
        $('.question').hide();
        $('.section').hide();
        $('.finished').hide();
        $('.studyInfo').hide();
        $('.commentSection').hide();
        $('.whyLow').hide();
        $('.whyHigh').hide();

        //Show full survey details
        $('.showStudyInfo').on('click', function() {
            $('.studyInfo').toggle();
        })

        //Initiate survey:
        $('.contextForm').on('submit', function(e){
            //Prevent page from refreshing
            e.preventDefault();

            //check if one answer is checked, otherwise do nothing:
            if($('.contextQ').is(':checked'))
            {

                //Get response
                userContext = $('input:checked').val();
                console.log('User Context:');
                console.log(userContext);

                //Hide Start section
                $('.startQuiz').hide();
            
                //Display the first only to start with
                $('.section0').show();
                $('.question0').show();
            }
        });

        
        //Keep track of what's been answered
        var clicked = 0;
        var questionsInSection = 0;
        var sectionsPassed = 0;

        //Display

        //On click
        $('.button').on('click', function() {

            //Check if an option was selected - otherwise do nothing
            if($('.question'+clicked).is(':checked'))
            {
                var foundNextQuestion = false;
                var round = 0;

                selectedAnswer = $(':checked','.question'+clicked).val();

   
                    console.log('No Why')

                    //While we haven't settled on a question to display
                    while(foundNextQuestion == false)
                    {
                        //Check which question and section we're in
                        currentQuestion = '.question'+clicked;
                        currentSection = '.section'+sectionsPassed;

                        //Get the answer, if the user just answered. Otherwise log -1:
                        if(round == 0)
                        {
                            userAnswer = selectedAnswer;
                        }
                        else
                        {
                            userAnswer = -1;
                        }
                        console.log(userAnswer);
                        dataReturn.push(userAnswer);

                        //Check if we're in a new section
                        questionsInSection++;
                        if (questionsInSection==parts[sectionsPassed].questions.length)
                        {
                            sectionsPassed++;
                            questionsInSection = 0;

                            $(currentSection).hide();
                            currentSection = '.section'+sectionsPassed;
                            $(currentSection).show();
                        }

                        //Check if there even is a next question
                        clicked++;
                        nextQuestion = '.question'+clicked;

                        //If not, display finished and exit loop:
                        if(clicked==questionCounter)
                        {
                            $('.commentSection').show();

                            console.log(dataReturn);
                                        
                            //Call Firebase
                            var dbRefProbs = firebase.database().ref('Probs');

                            //Redownload Data (so it's fresh, we'll use this newer copy to update UBCs)
                            dbRefProbs.once('value', (response) => {
                                initialSeqData = response.val().data;
                            });

                            //Exit loop
                            foundNextQuestion = true;
                        }

                        //Otherwise, check whether or not we display next question:
                        else
                        {
                            $(currentQuestion).hide();
                            if(seqToRun[userContext][clicked] == 1)
                            {
                                $(nextQuestion).show();
                                foundNextQuestion = true;
                            }

                            //Otherwise, we just increase the round number and loop over to look for the next question  
                        }

                    round++;
                    
                }  
            }              
        })


        //When 'Submit' is clicked (i.e. we're done)

        //Grab Comments and finish things
        $('.commentForm').on('submit', function(e){
            //Prevent page from refreshing
            e.preventDefault();

            //Get response
            userFeedback = $('textarea').val();
            console.log('Feedback:');
            console.log(userFeedback);

            //Push results into Firebase DB:
            var dbRef = firebase.database().ref('Results');

            if(whys.length > 0)
            {        
                whyResults = [whys[0]];
                whyCheck = 0;
                for(w = 0; w  < whys.length; w++)
                {
                    if(whys[w].substring(0,3) != whyResults[whyCheck].substring(0,3))
                    {
                        whyResults.push(whys[w]);
                        whyCheck++;
                    }
                }
            }
            else
            {
                whyResults = [];
            }

            //Create result item:
            result = {
                answers : dataReturn,
                context : 'C'+userContext,
                feedback : userFeedback,
                qSequence : runSummary,
                whys: whyResults
            };

            console.log('Results recorded:');
            console.log(result);
            console.log('whyResults')
            console.log(whyResults)

            dbRef.push(result);

            //Call the other DBs
            var dbRefProbs = firebase.database().ref('Probs');
            var dbRefProbHist = firebase.database().ref('History');

            //Update probability distributions of future sequences
            var updatedUBC;
            updatedUBC = updateUBC(dataReturn, initialSeqData, runSummary, dbAccesses);

            returnData = 
            {
                name:'X',
                data:updatedUBC,//sequenceData,
                accessCount:dbAccesses+1//0
            };
            console.log(returnData);

            //Log the updates
            dbRefProbs.set(returnData); 
            dbRefProbHist.push(returnData);

            //Hide comments section
            $('.commentSection').hide();
            
            //Display the finished 1section
            $('.finished').show();
        });

    })


  </script>



</html>
