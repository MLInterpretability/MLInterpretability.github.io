<!--HTML-->

<html>
    <image src='oxweb-logo.gif'></image>
  <!--CSS-->
  <link rel="stylesheet" href="Styles.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
 
  <div id='Intro'>
  <head>
 <h1>
  Machine Learning Interpretability Study
 </h1>
</head>
  <h3>Details</h3>
  <p>
    Thank you for your interest in our study.</br>
    The purpose of the study is the explore users' confidence in using different machine learning models to predict outcomes for patient scenarios, given various forms of evidence, interpretations, and representations.<br />
    Please click below for full details before you start the quiz.</p>
    <button class = 'showStudyInfo'>Full Study Info</button>
  <div class='studyInfo' style='font-size:75%;'>
    <h5>General Information</h5>
        <p>Machine Learning and Artificial Intelligence models are gaining enthusiasm for their ability to produce highly accurate predictive and analytical insights. However, as many such models, including neural networks, are <i>black-boxes</i>, many fields of practice are reluctant to utilize these models without an ability to interpret their results or understand a model made its prediction.</p>
        <p>The aim of this study is to explore this phenomenon and understand what type of model evidence and interpretability modules will increase comprehension and the comfort levels for users of different machine learning predictive models.</p>
        <p>We appreciate your interest in participating in this online quiz. You have been invited to participate as a student in a STEM discipline. Please read through these terms before beginning the quiz. You will participate by ticking the <i>Start</i> box below. You may ask any questions before taking part by contacting the researcher (details below).</p>
        <p>We, the University of Oxford, are investigating Machine Learning model interpretability. You will be presented with limited information on a machine learning model, followed by further evidence regrading the model. You will then be asked to rate your confidence level with utilizing the model for predictive purposes.</p>
        <p>The full quiz should take about 10-15 minutes. No background knowledge is required. Your results will be utilized to determine the best interpretability modules and types of evidence to present to potential users of different machine learning models, and will be collected and utilized by the Computer Science and Engineering Departments at Oxford. <b>No personally identifiable information will be collected or shared</b>.</p>
    <h5>Do I have to take part?</h5>
        <p>Please note that your participation is voluntary. You may withdraw at any point during the questionnaire for any reason, before submitting your answers, by closing the browser. None of your answers will then be collected.</p>
    <h5>How will your data be used?</h5>
        <p>Your answers will be completely anonymous, and we will use all reasonable endeavours to keep them confidential. No personally identifiable, including but not limited to IP address, email address, or name, will be requested or collected.</p>
        <p>Your answers will be stored in a password-protected file and may be used in academic publications. Your IP address will not be stored. Research data will be stored for a minimum of three years after publication or public release.</p>
    <h5>Who will have access to your data?</h5>
        <p>The University of Oxford is the data controller for the purposes of the Data Protection Act 1998.</p>
        <p>We would like your permission to use your unidentifiable data in future studies, and to share data with other researchers (e.g. in online databases).</p>
        <p>Any personal information that could identify you will not be collected or be removed before files are shared with other researchers or results are made public.</p>
        <p>This questionnaire is for an MSc project. The principal researcher is Owen Lahav, who is attached to the Department of Computer Science at the University of Oxford. This project is being completed under the supervision of Mihaela van der Schaar and Edith Elkind. This project has been reviewed by the University of Oxford’s Department of Computer Science’s Research Ethics Committee.</p>
    <h5>What if there is a problem?</h5>
        <p>If you have a concern about any aspect of this project, please speak to the researcher at oren.lahav@gtc.ox.ac.uk who will do his best to answer your query. The researcher should acknowledge your concern within 10 working days and give you an indication of how they intend to deal with it.</p>
        <p>If you are over 18 and have read the information above and agree to participate with the understanding that the data (including any personal data) you submit will be processed accordingly, please click the ‘Start’ box below to get started. By doing so you will be providing your consent to participate.</p>
  </div>
    <h3>Instructions:</h3>
  <p>
    Please review the patient scenario and evidence presented, and assess your level of comfort utilizing the models described to the best of your ability after each question.
    <b>Please do not use the back/forward or refresh buttons once you have started the quiz.</b>
  </p>
 </div>

 <div class = 'startQuiz'>
     <h3>Start</h3>
     <p>Please click Next if you are ready to begin:</p>
     <form class='consentForm'>
            <button>Next</button>
     </form>
  </div>

 <div id = 'Rest'></div>

 <div class = 'finished'>
     <h3>Finished!!!</h3>
    <p>
        Thank you very much for taking our quiz. Your anonymous results will be used in a model that shall determine the best evidence to present to potential users of ML models.
    </p>
</div>
 
<!--CODE-->

<!--Setup Firebase-->
<script src="https://www.gstatic.com/firebasejs/5.0.4/firebase.js"></script>
<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyCPsD608Ch-EKwS6FAhs4oyUC1oq3xh-jA",
    authDomain: "interpretabilitytry2.firebaseapp.com",
    databaseURL: "https://interpretabilitytry2.firebaseio.com",
    projectId: "interpretabilitytry2",
    storageBucket: "",
    messagingSenderId: "710256823813"
  };
  firebase.initializeApp(config);
</script>

<!--Download jQuery-->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>

<!--Actual code-->
  <script>
    //Setup variables:

    
    var part1 = {
        header : '<b>Part 1:</b> Background',
        description : 'This question identifies YOUR background',
        questions : [
            {
                questionText : '<b>Please indicate your program and level of study:</b>',
                answers : ['Medical (or related), Undergraduate',
                'Medical (or related), Postgraduate',
                'Mathematics, Statistics, Computer Science (or related), Undergraduate',
                'Mathematics, Statistics, Computer Science (or related), Postgraduate',
                'Other'
                ]
            }
        ]
    };
    var part2 = {
        header : '<b>Part 2:</b> Logistic Regression Model',
        description : '<p>The following questions pertain to a <b>logistic regression</b> model based on the Wiscounsin Diagnostic Breast Cancer dataset.<br />This simple classification model uses a linear combiantion of various dependent features to estimate the probability of a breast tumour being benign or malignant.</p><p>Please examine the following scenario and relevant evidence in order and assess your level of confidence in the model after each step.</p>',
        questions : [
            {
                questionText : '<image src="M1Q1.png" style="width:1000px;"></image><p>Given the above and previous information, how confident would you feel using the results of the model to inform medical actions?</p>',
                answers: ['Not at all confident, will not even consult model when considering further action',
                            'Not very confident, unlikely to consult model',
                            'Somewhat confident, may consult model but unlikely to rely on it in any way',
                            'Fairly confident, likely to consult model',
                            'Very confident, almost certain to consult model together with other tools when considering further actions'
                ]
            },
            {
                questionText : '<image src="M1Q2.png" style="width:1000px;"></image><p>Given the above and previous information, how confident would you feel using the results of the model to inform medical actions?</p>',
                answers : ['Not at all confident, will not even consult model when considering further action',
                            'Not very confident, unlikely to consult model',
                            'Somewhat confident, may consult model but unlikely to rely on it in any way',
                            'Fairly confident, likely to consult model',
                            'Very confident, almost certain to consult model together with other tools when considering further actions'
                ]
            },
            {
                questionText : '<image src="M1Q3.png" style="width:1000px;"></image><p>Given the above and previous information, how confident would you feel using the results of the model to inform medical actions?</p>',
                answers : ['Not at all confident, will not even consult model when considering further action',
                            'Not very confident, unlikely to consult model',
                            'Somewhat confident, may consult model but unlikely to rely on it in any way',
                            'Fairly confident, likely to consult model',
                            'Very confident, almost certain to consult model together with other tools when considering further actions'
                ]
            },
            {
                questionText : '<image src="M1Q4.png" style="width:1000px;"></image><p>Given the above and previous information, how confident would you feel using the results of the model to inform medical actions?</p>',
                answers : ['Not at all confident, will not even consult model when considering further action',
                            'Not very confident, unlikely to consult model',
                            'Somewhat confident, may consult model but unlikely to rely on it in any way',
                            'Fairly confident, likely to consult model',
                            'Very confident, almost certain to consult model together with other tools when considering further actions'
                ]
            },
            {
                questionText : '<image src="M1Q5.png" style="width:1000px;"></image><p>Given the above and previous information, how confident would you feel using the results of the model to inform medical actions?</p>',
                answers : ['Not at all confident, will not even consult model when considering further action',
                            'Not very confident, unlikely to consult model',
                            'Somewhat confident, may consult model but unlikely to rely on it in any way',
                            'Fairly confident, likely to consult model',
                            'Very confident, almost certain to consult model together with other tools when considering further actions'
                ]
            }
        ]
    };

    var part3 = {
        header : '<b>Part 3:</b> Neural Network',
        description : '<p>The following questions pertain to a <b>neural network</b>, a sophisticated black-box machine learning model. The model was trained on a Heart Failure dataset and utilizes several features to predict the event that a patient suffering heart failure will die within one year.</p><p>Please examine the following scenario and relevant evidence in order and assess your level of confidence in the model after each step.</p>',
        questions : [
            {
                questionText : '<image src="M2Q1.png" style="width:1000px;"></image><p>Given the above and previous information, how confident would you feel using the results of the model to inform medical actions?</p>',
                answers: ['Not at all confident, will not even consult model when considering further action',
                            'Not very confident, unlikely to consult model',
                            'Somewhat confident, may consult model but unlikely to rely on it in any way',
                            'Fairly confident, likely to consult model',
                            'Very confident, almost certain to consult model together with other tools when considering further actions'
                ]
            },
            {
                questionText : '<image src="M2Q2.png" style="width:1000px;"></image><p>Given the above and previous information, how confident would you feel using the results of the model to inform medical actions?</p>',
                answers : ['Not at all confident, will not even consult model when considering further action',
                            'Not very confident, unlikely to consult model',
                            'Somewhat confident, may consult model but unlikely to rely on it in any way',
                            'Fairly confident, likely to consult model',
                            'Very confident, almost certain to consult model together with other tools when considering further actions'
                ]
            },
            {
                questionText : '<image src="M2Q3.png" style="width:1000px;"></image><p>Given the above and previous information, how confident would you feel using the results of the model to inform medical actions?</p>',
                answers: ['Not at all confident, will not even consult model when considering further action',
                            'Not very confident, unlikely to consult model',
                            'Somewhat confident, may consult model but unlikely to rely on it in any way',
                            'Fairly confident, likely to consult model',
                            'Very confident, almost certain to consult model together with other tools when considering further actions'
                ]
            },
        ]
    };

    var parts = [part1, part2, part3];
    var questionCodes = [
        {qCode: 1,display: [[1],[1,1,1,1],[1,1,0]], prob: 0.4},
        {qCode: 2,display: [[1],[1,0,1,0],[1,0,1]], prob: 0.3},
        {qCode: 3,display: [[1],[0,1,0,1],[0,1,0]], prob: 0.3}
    ];

    //var answerKey = [0,2];

    var sequenceData = [
        {
            section: 1, possibleSequences:[
                {seqCode:'M0S0', seq: [1], numTries: 0, currentMean : 2.5, currentUCB : 1}
            ]
        },
        {
            section: 2, possibleSequences:[
                {seqCode:'M1S0', seq: [1,0,0,1,0], numTries: 0, currentMean : 2.5, currentUCB : 10},
                {seqCode:'M1S1', seq: [0,1,0,1,0], numTries: 0, currentMean : 2.5, currentUCB : 10},
                {seqCode:'M1S2', seq: [0,0,1,1,0], numTries: 0, currentMean : 2.5, currentUCB : 10},
                {seqCode:'M1S3', seq: [1,0,0,0,1], numTries: 0, currentMean : 2.5, currentUCB : 10},
                {seqCode:'M1S4', seq: [0,1,0,0,1], numTries: 0, currentMean : 2.5, currentUCB : 10},
                {seqCode:'M1S5', seq: [0,0,1,0,1], numTries: 0, currentMean : 2.5, currentUCB : 10}
            ]
        },
        {
            section: 3, possibleSequences:[
                {seqCode:'M2S0', seq: [1,1,0], numTries: 0, currentMean : 2.5, currentUCB : 10},
                {seqCode:'M2S1', seq: [1,0,1], numTries: 0, currentMean : 2.5, currentUCB : 10},
                {seqCode:'M2S2', seq: [0,1,0], numTries: 0, currentMean : 2.5, currentUCB : 10},
                {seqCode:'M2S2', seq: [0,0,1], numTries: 0, currentMean : 2.5, currentUCB : 10}
            ]
        }
    ];


    var questionCounter = 0;
    var sectionCounter = 0;

    //Create function to display a question:
    function displayQuestion(qNum, q)
    {
        var output = [];
        var answersList = [];

        //Setup answers one by one
        for(ans in q.answers)
        {
            answersList.push(
                '<label class="question question'+qNum+'">'
					+ '<input type="radio" name="question'+qNum+'" class="question'+qNum+'" value="'+ans+'">'
					+ (ans) + ': '
					+ q.answers[ans]
				+ '</label><br />'
			    );
		}

        //Push question text and answers
        output.push(
			'<div class="question question'+qNum+'">' + q.questionText + '<br />'
			+ '<div class="answers">' + answersList.join('') + '<br /></div>'
            + '<div value="'+qNum+'" class="button question question'+qNum+'"><button>Next</button></div></div>'
		);
        //console.log(output)

        //Add output to current HTML
        return output;
    }

    function displaySection(sectionNum,section)
    {
        output = [];
        questionList = [];

        //Choose which questions to display by probability
        for(var q=0; q<section.questions.length; q++)
        {
           questionList.push(displayQuestion(questionCounter,section.questions[q]));
           questionCounter++;
        }
        
        //Add question list to output and return
        output.push(
            '<div class="section section'+sectionNum+'"><h3>' 
            + section.header 
            +'</h3><p>'
            + section.description
            + '</p>'
            + '<div class="questions">' + questionList.join('') + '</div></div>'
        );

        return output;
    }

    function displayAll(sectionList)
    {
        output = ''
        for(var s = 0; s<sectionList.length;s++)
        {
            output = output+displaySection(sectionCounter,sectionList[s]);
            sectionCounter++;
        }
        return output
    }

    var sequence = questionCodes[0];
    var dbAccesses = 1;
    var dbSeqData;


    //Function to choose, based on UCB, which sequence to show
    function chooseSequence()
    {
        seqToRun = [];
        runSummary = [];

        //First things first - get latest prob from DB
        var dbRefProbs = firebase.database().ref('Probs');

        dbRefProbs.once('value', (response) => {
            
                dbSeqData = response.val().data;
                dbAccesses = response.val().accessCount;
                console.log(dbSeqData);
                console.log('Accesses: '+dbAccesses);

                //For! Each section:
                for (var sect = 0; sect < dbSeqData.length; sect++)
                {
                    console.log('Section?');
                    console.log(sect);
                    console.log(dbSeqData[sect].possibleSequences);

                    topSeq = [];
                    topCode = '';
                    UCBTrack = 0;

                    possSeqs = dbSeqData[sect].possibleSequences;
                    
                    //Cycle through sequences
                    for (var pSeq = 0; pSeq < possSeqs.length; pSeq++)
                    {
                        //If UCB is higher than the previous one, set this sequence to be chosen
                        if (possSeqs[pSeq].currentUCB >= UCBTrack)
                        {
                            topCode = possSeqs[pSeq].seqCode;
                            topSeq = possSeqs[pSeq].seq;
                            UCBTrack = possSeqs[pSeq].currentUCB;
                        }
                    }

                    seqToRun = seqToRun.concat(topSeq);
                    runSummary.push({
                        sectionNo: dbSeqData[sect].section,
                        seqCode : topCode,
                        seqDesc : topSeq
                    });

                }

                console.log('This trial we shall run:')
                console.log(seqToRun);
                console.log(runSummary);
        });
    }


    //Function to update UCB once quiz is done

    function updateUBC(resultList, initialSeqData, runSummary, numAccess)
    {
        console.log('UBC Update Step initiate!');
        console.log(initialSeqData);

        //Update total number of accesses
        upAccesses = numAccess + 1;
    
        //Set up the updated sequence data vector to return.
        //Section0, the context question, always remains the same:
        upSeqData = [{section:1,possibleSequences:[{seqCode:'M0S0', seq: [1], numTries: 1, currentMean : 0.5, currentUCB : 1}]}];
        qSoFar = 1;

        //For every subsequent section
        for(var a = 0; a < initialSeqData.length - 1; a++)
        {
            sectData = initialSeqData[a+1];

            //Find the final confidence score in the model (that's our reward):
            qSoFar = qSoFar + sectData.possibleSequences[0].seq.length
            confScore = resultList[qSoFar-1];
            wloop = qSoFar - 2;
            while(confScore == -1 && qSoFar >= 0)
            {
                confScore = resultList[wloop];
                wloop = wloop - 1;
            }

            ranCode = runSummary[a+1].seqCode;

            upPossSeq = []

            //For each possible sequence:
            for (var b = 0; b < sectData.possibleSequences.length; b++)
            {
                curSeq = sectData.possibleSequences[b];

                //If we're at the sequence we ran, we must update many things:
                if (curSeq.seqCode == ranCode)
                {
                    upTries = curSeq.numTries + 1;
                    upMean = ((curSeq.currentMean*curSeq.numTries) + parseInt(confScore))/upTries;
                    upUCB = upMean + Math.min(Math.sqrt(2*(Math.log(upAccesses)/Math.log(upTries))),10);

                    //Check for NaN:
                    if (isNaN(upUCB) || upTries<=1) {upUCB=10;}
                }
                else
                {
                    upTries = curSeq.numTries;
                    upMean = curSeq.currentMean;
                    upUCB = upMean + Math.min(Math.sqrt(2*(Math.log(upAccesses)/Math.log(upTries))),10);

                    //Check for NaN:
                    if (isNaN(upUCB) || upTries<=1) {upUCB=10;}
                }

                upSeq = {
                    seqCode : curSeq.seqCode,
                    seq : curSeq.seq,
                    numTries : upTries,
                    currentMean : upMean,
                    currentUCB : upUCB
                };

                upPossSeq.push(upSeq);
            }

            upSect = {section:a+2,possibleSequences:upPossSeq};
            upSeqData.push(upSect);
        }
        console.log('Updated UCB Values: ')
        console.log(upSeqData);
        return upSeqData;
    }

    //Variable to store data:
    dataReturn = [];

    //Set code to run once page is loaded
    $(document).ready(function() {

        //Prepare things to display:
        var pageStuff = document.getElementById('Rest');
        pageContent = displayAll(parts);
        pageStuff.innerHTML = pageStuff.innerHTML + pageContent;

        console.log(pageStuff.innerHTML);

        //Figure out the sequence
        chooseSequence();

        //All the action starts here!

        //Hide all questions and sections:
        $('.question').hide();
        $('.section').hide();
        $('.finished').hide();
        $('.studyInfo').hide();

        //Show full quiz details
        $('.showStudyInfo').on('click', function() {
            $('.studyInfo').toggle();
        })

        //Initiate quiz:
        $('.consentForm').on('submit', function(e){
            //Prevent page from refreshing
            e.preventDefault();

            //Hide Start section
            $('.startQuiz').hide();
            
            //Display the first only to start with
            $('.section0').show();
            $('.question0').show();
        });

        
        //Keep track of what's been answered
        var clicked = 0;
        var questionsInSection = 0;
        var sectionsPassed = 0;

        //Display

        //On click
        $('.button').on('click', function() {
            var foundNextQuestion = false;
            var round = 0;

            //While we haven't settled on a question to display
            while(foundNextQuestion == false)
            {
                //Check which question and section we're in
                currentQuestion = '.question'+clicked;
                currentSection = '.section'+sectionsPassed;

                //Get the answer, if the user just answered. Otherwise log -1:
                if(round == 0)
                {
                    userAnswer = $(':checked',currentQuestion).val();
                }
                else
                {
                    userAnswer = -1;
                }
                console.log(userAnswer);
                dataReturn.push(userAnswer);

                //Check if we're in a new section
                questionsInSection++;
                if (questionsInSection==parts[sectionsPassed].questions.length)
                {
                    sectionsPassed++;
                    questionsInSection = 0;

                    $(currentSection).hide();
                    currentSection = '.section'+sectionsPassed;
                    $(currentSection).show();
                }

                //Check if there even is a next question
                clicked++;
                nextQuestion = '.question'+clicked;

                //If not, display finished and exit loop:
                if(clicked==questionCounter)
                {
                    $('.finished').show();
                    console.log(dataReturn);
                    
                    //Also push it to Firebase!
                    var dbRef = firebase.database().ref('Results');
                    
                    //Create result item:
                    result = {
                        answers : dataReturn,
                        qSequence : runSummary
                    };

                    dbRef.push(result);

                    //Update probability distributions of future sequences
                    //Call Firebase
                    var dbRefProbs = firebase.database().ref('Probs');
                    var dbRefProbHist = firebase.database().ref('History');
                    
                    var initialSeqData;

                    dbRefProbs.once('value', (response) => {
                        initialSeqData = response.val().data;
                    });

                    //Run the update function
                    updatedUBC = updateUBC(dataReturn, initialSeqData, runSummary, dbAccesses);

                    returnData = 
                    {
                        name:'X',
                        data:updatedUBC,//sequenceData,
                        accessCount:dbAccesses+1//0
                    };
                    console.log(returnData);

                    //Log the updates
                    dbRefProbs.set(returnData); 
                    dbRefProbHist.push(returnData);


                    //Exit loop
                    foundNextQuestion = true;
                }

                //Otherwise, check whether or not we display next question:
                else
                {
                    $(currentQuestion).hide();
                    if(seqToRun[clicked] == 1)
                    {
                        $(nextQuestion).show();
                        foundNextQuestion = true;
                    }

                    //Otherwise, we just increase the round number and loop over to look for the next question
                    
                }

                round++;
            }
                        
        })
    })
  </script>


  </script>

</html>
